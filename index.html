<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Perfect Game - Pro Character Update</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        #ui { position: absolute; bottom: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px black; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui">
        <b>WASD</b>: Move (Procedural Walk) | <b>Q</b>: Dynamic Punch | <b>Space</b>: Exit Car
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- WORLD ---
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x2ecc71 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);
        
        const road = new THREE.Mesh(new THREE.PlaneGeometry(20, 1000), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        road.rotation.x = -Math.PI / 2; road.position.y = 0.01;
        scene.add(road);

        // --- PRO PLAYER MODEL (Hierarchical) ---
        const playerGroup = new THREE.Group();
        
        // Torso
        const torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.6), new THREE.MeshStandardMaterial({ color: 0x3498db }));
        torso.position.y = 1.3;
        playerGroup.add(torso);

        // Head & Visor (Directionality)
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), new THREE.MeshStandardMaterial({ color: 0x3498db }));
        head.position.y = 1.1;
        const visor = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.1), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        visor.position.set(0, 0.1, 0.35);
        head.add(visor);
        torso.add(head);

        // Arms
        const armL = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.8, 0.3), new THREE.MeshStandardMaterial({ color: 0x2980b9 }));
        armL.position.set(-0.7, 0, 0);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.8, 0.3), new THREE.MeshStandardMaterial({ color: 0x2980b9 }));
        armR.position.set(0.7, 0, 0);
        torso.add(armL, armR);

        // Legs
        const legL = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.8, 0.4), new THREE.MeshStandardMaterial({ color: 0x1c5980 }));
        legL.position.set(-0.3, -1, 0);
        const legR = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.8, 0.4), new THREE.MeshStandardMaterial({ color: 0x1c5980 }));
        legR.position.set(0.3, -1, 0);
        playerGroup.add(legL, legR);

        playerGroup.position.set(0, 1, 10);
        scene.add(playerGroup);

        // --- CARS ---
        const car = new THREE.Group();
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(3, 1.5, 6), new THREE.MeshStandardMaterial({color: 0xff4757}));
        carBody.position.y = 0.75;
        car.add(carBody);
        car.position.set(10, 0, 0);
        scene.add(car);

        // --- LOGIC ---
        const keys = {};
        let isDriving = false;
        let walkTime = 0;
        let punchTime = 0;
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function update() {
            const speed = 0.2;
            let moving = false;

            if (!isDriving) {
                // Directional Movement
                let moveDir = new THREE.Vector3(0,0,0);
                if (keys['w']) moveDir.z -= 1;
                if (keys['s']) moveDir.z += 1;
                if (keys['a']) moveDir.x -= 1;
                if (keys['d']) moveDir.x += 1;

                if (moveDir.length() > 0) {
                    moving = true;
                    moveDir.normalize();
                    playerGroup.position.add(moveDir.multiplyScalar(speed));
                    
                    // Rotation Logic (Face where moving)
                    const targetAngle = Math.atan2(moveDir.x, moveDir.z);
                    playerGroup.rotation.y = THREE.MathUtils.lerp(playerGroup.rotation.y, targetAngle, 0.15);
                    
                    // Procedural Walk (Sin waves)
                    walkTime += 0.2;
                    legL.position.z = Math.sin(walkTime) * 0.5;
                    legR.position.z = Math.sin(walkTime + Math.PI) * 0.5;
                    armL.position.z = Math.sin(walkTime + Math.PI) * 0.4;
                    armR.position.z = Math.sin(walkTime) * 0.4;
                    torso.position.y = 1.3 + Math.abs(Math.cos(walkTime)) * 0.1; // "The Bounce"
                    torso.rotation.x = 0.1; // "The Lean"
                } else {
                    // Idle Breathing
                    walkTime += 0.05;
                    torso.position.y = 1.3 + Math.sin(walkTime) * 0.02;
                    legL.position.z = legR.position.z = 0;
                    armL.position.z = armR.position.z = 0;
                    torso.rotation.x = 0;
                }

                // Dynamic Punching (Q)
                if (keys['q']) {
                    punchTime += 0.5;
                    armR.position.z = -1.5; // Punch arm out
                    armR.position.y = 0.2;
                    torso.rotation.y = 0.3; // Body twist
                } else {
                    armR.position.set(0.7, 0, 0);
                    torso.rotation.y = 0;
                }

                // Car Entry
                if (playerGroup.position.distanceTo(car.position) < 4) {
                    isDriving = true;
                    playerGroup.visible = false;
                }
            } else {
                // Driving Logic
                if (keys['w']) car.translateZ(-speed * 3);
                if (keys['s']) car.translateZ(speed * 3);
                if (keys['a']) car.rotation.y += 0.04;
                if (keys['d']) car.rotation.y -= 0.04;
                if (keys[' ']) { isDriving = false; playerGroup.visible = true; playerGroup.position.copy(car.position).add(new THREE.Vector3(5,0,0)); }
            }

            // Lighting & Camera
            const target = isDriving ? car.position : playerGroup.position;
            camera.position.lerp(new THREE.Vector3(target.x, target.y + 10, target.z + 15), 0.1);
            camera.lookAt(target);
        }

        const light = new THREE.DirectionalLight(0xffffff, 1.2);
        light.position.set(10, 20, 10);
        scene.add(light, new THREE.AmbientLight(0x707070));

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
