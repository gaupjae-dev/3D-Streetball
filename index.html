<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Underground 3D: Clique Wars</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
            pointer-events: none; border-left: 5px solid #ff4757;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 10px; height: 10px; background: rgba(255,255,255,0.5);
            border-radius: 50%; transform: translate(-50%, -50%);
        }
        #instructions {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: white; background: rgba(0,0,0,0.5); padding: 10px 0;
        }
        .stat { font-size: 1.2rem; margin-bottom: 5px; }
        .val { color: #ff4757; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">Cash: <span id="cash" class="val">$100</span></div>
        <div class="stat">Power: <span id="power" class="val">10</span></div>
        <div class="stat">Districts: <span id="districts" class="val">0/5</span></div>
        <div id="msg" style="margin-top:10px; color:#00ff00;">Walk into markers to act!</div>
    </div>

    <div id="crosshair"></div>
    <div id="instructions">WASD to Move | Mouse to Look | Click to Lock Pointer</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- Game Logic Stats ---
        let stats = { cash: 100, power: 10, districts: 0 };
        const updateUI = (msg) => {
            document.getElementById('cash').innerText = `$${stats.cash}`;
            document.getElementById('power').innerText = stats.power;
            document.getElementById('districts').innerText = `${stats.districts}/5`;
            if(msg) document.getElementById('msg').innerText = msg;
        };

        // --- Scene Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a12);
        scene.fog = new THREE.FogExp2(0x0a0a12, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
        scene.add(light);

        // --- Controls ---
        const controls = new PointerLockControls(camera, document.body);
        document.body.addEventListener('click', () => controls.lock());

        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        const onKeyDown = (e) => {
            switch (e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
            }
        };
        const onKeyUp = (e) => {
            switch (e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        };
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        // --- Environment (The City) ---
        const floorGeo = new THREE.PlaneGeometry(2000, 2000);
        const floorMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Buildings
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);
        for (let i = 0; i < 100; i++) {
            const h = Math.random() * 20 + 5;
            const bMat = new THREE.MeshPhongMaterial({ color: 0x222222 });
            const building = new THREE.Mesh(boxGeo, bMat);
            building.position.x = Math.floor(Math.random() * 20 - 10) * 10;
            building.position.z = Math.floor(Math.random() * 20 - 10) * 10;
            building.position.y = h / 2;
            building.scale.set(8, h, 8);
            scene.add(building);
        }

        // --- Interactive Markers ---
        const markers = [];
        function createMarker(x, z, type, cost) {
            const geo = new THREE.CylinderGeometry(1, 1, 0.5, 32);
            const color = (type === 'mission') ? 0xff4757 : 0x2e95ff;
            const mat = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
            const marker = new THREE.Mesh(geo, mat);
            marker.position.set(x, 0.5, z);
            marker.userData = { type, cost, active: true };
            scene.add(marker);
            markers.push(marker);
            
            // Add a light to the marker
            const pLight = new THREE.PointLight(color, 10, 5);
            pLight.position.set(x, 2, z);
            scene.add(pLight);
        }

        // Add some missions and territories
        createMarker(10, 10, 'mission', 0);
        createMarker(-15, 20, 'mission', 0);
        createMarker(20, -10, 'territory', 25); // Needs 25 power
        createMarker(-20, -30, 'territory', 50); // Needs 50 power

        // --- Game Loop ---
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        let prevTime = performance.now();

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            if (controls.isLocked) {
                const delta = (time - prevTime) / 1000;

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // Collision Detection with Markers
                markers.forEach(m => {
                    if (!m.userData.active) return;
                    
                    const dist = camera.position.distanceTo(m.position);
                    if (dist < 2) {
                        if (m.userData.type === 'mission') {
                            stats.cash += 20;
                            stats.power += 5;
                            updateUI("Mission Clear! +$20 +5 Power");
                            m.userData.active = false;
                            m.visible = false;
                            // Respawn mission elsewhere later
                            setTimeout(() => { m.visible = true; m.userData.active = true; }, 5000);
                        } 
                        else if (m.userData.type === 'territory') {
                            if (stats.power >= m.userData.cost) {
                                stats.districts++;
                                stats.power -= 5;
                                updateUI(`District Captured!`);
                                m.userData.active = false;
                                m.material.wireframe = false; // Solid when owned
                                m.material.color.set(0x2ed573);
                            } else {
                                updateUI(`Need ${m.userData.cost} Power to take this!`);
                            }
                        }
                    }
                });
            }

            prevTime = time;
            renderer.render(scene, camera);
        }

        animate();

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
