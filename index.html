<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D City - Fixed Collisions</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; pointer-events: none; }
        #map-btn { position: absolute; bottom: 20px; right: 20px; padding: 10px 20px; z-index: 100; cursor: pointer; }
        #map-overlay { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; background: rgba(50,50,50,0.9); border: 2px solid #fff; z-index: 90; }
        .dot { width: 8px; height: 8px; background: lime; position: absolute; border-radius: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>

<div id="ui">
    <b>CITY SIMULATOR</b><br>
    WASD to Drive/Walk<br>
    Status: <span id="status">Exploring</span>
</div>

<button id="map-btn" onclick="toggleMap()">MAP</button>
<div id="map-overlay"><div id="player-dot" class="dot"></div></div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222233);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambient);
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(50, 50, 50);
    scene.add(sun);

    const collidables = [];
    const cars = [];

    // --- THE WORLD ---
    // Ground
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({color: 0x222222}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Streets
    function makeRoad(x, z, w, l, rot=0) {
        const road = new THREE.Mesh(new THREE.PlaneGeometry(w, l), new THREE.MeshStandardMaterial({color: 0x111111}));
        road.rotation.x = -Math.PI/2;
        road.rotation.z = rot;
        road.position.set(x, 0.05, z);
        scene.add(road);
    }
    for(let i=-2; i<=2; i++) {
        makeRoad(i*60, 0, 15, 400); // North-South
        makeRoad(0, i*60, 15, 400, Math.PI/2); // East-West
    }

    // --- DOWNTOWN ARENA (The Landmark) ---
    const arena = new THREE.Mesh(
        new THREE.CylinderGeometry(15, 15, 10, 32),
        new THREE.MeshStandardMaterial({color: 0x5555ff, emissive: 0x111144})
    );
    arena.position.set(0, 5, 0); // Center
    scene.add(arena);
    collidables.push(arena);

    // --- BUILDINGS ---
    function spawnBuilding(x, z) {
        if (Math.abs(x) < 30 && Math.abs(z) < 30) return; // Keep center clear
        const h = 10 + Math.random() * 30;
        const b = new THREE.Mesh(
            new THREE.BoxGeometry(20, h, 20),
            new THREE.MeshStandardMaterial({color: 0x444455})
        );
        b.position.set(x, h/2, z);
        scene.add(b);
        collidables.push(b);
    }
    for(let x=-150; x<=150; x+=60) {
        for(let z=-150; z<=150; z+=60) {
            spawnBuilding(x+30, z+30);
        }
    }

    // --- NPC CARS ---
    function createCar(x, z, axis) {
        const car = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 4), new THREE.MeshStandardMaterial({color: Math.random() * 0xffffff}));
        car.position.set(x, 0.8, z);
        car.userData = { axis: axis, speed: 0.2 + Math.random() * 0.2 };
        scene.add(car);
        cars.push(car);
    }
    createCar(7, 50, 'z');
    createCar(-7, -50, 'z');

    // --- PLAYER ---
    const player = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({color: 0x00ff00}));
    player.position.set(0, 1, 40); // Spawn on the street away from Arena
    scene.add(player);

    // --- CONTROLS ---
    const keys = {};
    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;

    function checkWall(newX, newZ) {
        const pBB = new THREE.Box3().setFromCenterAndSize(
            new THREE.Vector3(newX, 1, newZ), 
            new THREE.Vector3(1.8, 1.8, 1.8)
        );
        for(let obj of collidables) {
            const objBB = new THREE.Box3().setFromObject(obj);
            if(pBB.intersectsBox(objBB)) return true;
        }
        return false;
    }

    function update() {
        let speed = 0.4;
        let nextX = player.position.x;
        let nextZ = player.position.z;

        if(keys['KeyW']) nextZ -= speed;
        if(keys['KeyS']) nextZ += speed;
        if(keys['KeyA']) nextX -= speed;
        if(keys['KeyD']) nextX += speed;

        if(!checkWall(nextX, player.position.z)) player.position.x = nextX;
        if(!checkWall(player.position.x, nextZ)) player.position.z = nextZ;

        // NPC Car Movement
        cars.forEach(c => {
            c.position[c.userData.axis] += c.userData.speed;
            if(c.position[c.userData.axis] > 200) c.position[c.userData.axis] = -200;
        });

        // UI & Camera
        camera.position.set(player.position.x, player.position.y + 15, player.position.z + 25);
        camera.lookAt(player.position);
        
        document.getElementById('player-dot').style.left = (player.position.x / 400 * 300 + 150) + 'px';
        document.getElementById('player-dot').style.top = (player.position.z / 400 * 300 + 150) + 'px';
        
        if(player.position.distanceTo(arena.position) < 25) {
            document.getElementById('status').innerText = "AT DOWNTOWN ARENA";
        } else {
            document.getElementById('status').innerText = "On the Street";
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        update();
        renderer.render(scene, camera);
    }
    animate();

    window.toggleMap = () => {
        const m = document.getElementById('map-overlay');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }
</script>
</body>
</html>
