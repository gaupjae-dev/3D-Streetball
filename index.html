<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Underground 3D: The Pit</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { 
            position: absolute; top: 20px; left: 20px; color: #0f0; 
            background: rgba(0,0,0,0.9); padding: 20px; border-left: 5px solid #00aaff;
            pointer-events: none; z-index: 10; width: 280px;
        }
        #arena-ui {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: none; color: #ff0000; font-size: 32px; font-weight: bold;
            text-shadow: 0 0 10px #000; z-index: 20;
        }
        .hp-bar { width: 100%; height: 10px; background: #300; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: 0.1s; }
        .btn-group { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 20; }
        button { background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-size: 20px; font-weight: bold;">SYNDICATE</div>
        <div id="rep-display" style="color: #00aaff;">REP: 0</div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="status-text" style="color: #0ff; font-size: 12px; margin-top: 5px;">ON FOOT</div>
    </div>

    <div id="arena-ui">ARENA DUEL: ACTIVE</div>

    <div class="btn-group">
        <button id="pauseBtn">PAUSE</button>
        <button id="mapBtn">MAP</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x05050a);
        scene.fog = new THREE.Fog(0x05050a, 15, 90);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(amb);

        // --- Game State ---
        let hp = 100, rep = 0, paused = false, mapMode = false, inVehicle = false, shake = 0;
        const keys = {}, buildings = [], enemies = [];
        let vehicleVel = 0, vehicleRot = 0;

        // --- Environment ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x080808 }));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // The Boxing Ring (The Pit)
        const ring = new THREE.Group();
        const ringFloor = new THREE.Mesh(new THREE.BoxGeometry(10, 0.5, 10), new THREE.MeshStandardMaterial({ color: 0x440000 }));
        ring.add(ringFloor);
        for(let i=0; i<4; i++) {
            const post = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 3), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            post.position.set(i < 2 ? 4.5 : -4.5, 1.5, i % 2 === 0 ? 4.5 : -4.5);
            ring.add(post);
        }
        ring.position.set(-60, 0, 0);
        scene.add(ring);

        // Garage & Districts
        function makeB(x, z, h, w, col) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(w, h, w), new THREE.MeshStandardMaterial({ color: col }));
            b.position.set(x, h/2, z);
            scene.add(b);
            buildings.push(b);
        }
        makeB(20, -20, 6, 15, 0x333333); // Garage
        for(let i=0; i<15; i++) makeB(Math.random()*60-30, Math.random()*20+10, 20, 6, 0x0a0a0a); // Downtown

        // --- Vehicle ---
        const vehicle = new THREE.Group();
        const vBody = new THREE.Mesh(new THREE.BoxGeometry(2.2, 1, 4.5), new THREE.MeshStandardMaterial({ color: 0xffcc00 }));
        vBody.position.y = 0.6;
        vehicle.add(vBody);
        vehicle.position.set(20, 0, -10);
        scene.add(vehicle);

        // --- Player ---
        const player = new THREE.Group();
        const pMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0x00aaff }));
        pMesh.position.y = 1;
        player.add(pMesh);
        scene.add(player);
        player.position.set(0, 0, 10);

        function spawnEnemy(x, z, size=1, isBoss=false) {
            const e = new THREE.Mesh(new THREE.BoxGeometry(size, 2*size, size), new THREE.MeshStandardMaterial({ color: isBoss?0xffaa00:0xff3333 }));
            e.position.set(x, size, z);
            e.userData = { hp: isBoss?300:50, isBoss };
            scene.add(e);
            enemies.push(e);
        }
        spawnEnemy(-10, -10); spawnEnemy(10, 10);

        // --- Logic ---
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        document.getElementById('pauseBtn').onclick = () => paused = !paused;
        document.getElementById('mapBtn').onclick = () => mapMode = !mapMode;

        function update() {
            if (paused) return;

            const activeObj = inVehicle ? vehicle : player;

            if (!inVehicle) {
                // Foot Controls
                const s = 0.2;
                if (keys['w']) player.position.z -= s;
                if (keys['s']) player.position.z += s;
                if (keys['a']) player.position.x -= s;
                if (keys['d']) player.position.x += s;

                // Enter Car
                if (keys['e'] && player.position.distanceTo(vehicle.position) < 4) {
                    inVehicle = true; player.visible = false;
                    document.getElementById('status-text').innerText = "DRIVING";
                }

                // Punching
                if (keys[' ']) {
                    pMesh.scale.set(1.4, 0.8, 1.4);
                    enemies.forEach((en, i) => {
                        if (player.position.distanceTo(en.position) < 3) {
                            en.userData.hp -= 5;
                            shake = 0.2;
                            if (en.userData.hp <= 0) { scene.remove(en); enemies.splice(i, 1); rep += 50; }
                        }
                    });
                } else pMesh.scale.set(1, 1, 1);

                // Arena Trigger
                if (player.position.distanceTo(ring.position) < 5) {
                    document.getElementById('arena-ui').style.display = 'block';
                    if (enemies.filter(e => e.userData.isBoss).length === 0) spawnEnemy(-60, 0, 1.5, true);
                } else { document.getElementById('arena-ui').style.display = 'none'; }

            } else {
                // Car Controls
                if (keys['w']) vehicleVel += 0.015;
                if (keys['s']) vehicleVel -= 0.01;
                vehicleVel *= 0.97;
                if (Math.abs(vehicleVel) > 0.01) {
                    if (keys['a']) vehicleRot += 0.04;
                    if (keys['d']) vehicleRot -= 0.04;
                }
                vehicle.rotation.y = vehicleRot;
                vehicle.translateZ(-vehicleVel);

                // Hit and Run Physics
                enemies.forEach((en, i) => {
                    if (vehicle.position.distanceTo(en.position) < 3.5 && Math.abs(vehicleVel) > 0.1) {
                        en.userData.hp -= Math.abs(vehicleVel) * 100;
                        en.position.addScaledVector(new THREE.Vector3().subVectors(en.position, vehicle.position).normalize(), 5);
                        shake = 0.5;
                        vehicleVel *= 0.5; // Impact slowdown
                    }
                });

                if (keys['f']) { inVehicle = false; player.visible = true; player.position.copy(vehicle.position).x += 3; }
            }

            // Camera Shake & Follow
            if (mapMode) {
                camera.position.lerp(new THREE.Vector3(activeObj.position.x, 80, activeObj.position.z + 0.1), 0.1);
            } else {
                const camH = inVehicle ? 12 : 15;
                const camD = inVehicle ? 18 : 18;
                camera.position.lerp(new THREE.Vector3(activeObj.position.x, activeObj.position.y + camH, activeObj.position.z + camD), 0.05);
            }
            if (shake > 0) { camera.position.x += Math.random() * shake; shake *= 0.9; }
            camera.lookAt(activeObj.position);

            // Enemy AI
            enemies.forEach(en => {
                const d = en.position.distanceTo(player.position);
                if (d < 15 && !inVehicle) {
                    en.position.addScaledVector(new THREE.Vector3().subVectors(player.position, en.position).normalize(), en.userData.isBoss ? 0.08 : 0.05);
                    if (d < 2) hp -= en.userData.isBoss ? 0.8 : 0.2;
                }
            });

            document.getElementById('hp-fill').style.width = hp + "%";
            document.getElementById('rep-display').innerText = "REP: " + rep;
            if (hp <= 0) location.reload();
        }

        function animate() { requestAnimationFrame(animate); update(); renderer.render(scene, camera); }
        animate();
    </script>
</body>
</html>
