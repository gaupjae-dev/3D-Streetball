<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Perfect Game - Driving Update</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #map-icon {
            position: absolute; top: 20px; right: 20px;
            width: 80px; height: 80px;
            background: rgba(0,0,0,0.8); border: 3px solid #ffcc00;
            border-radius: 15px; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; z-index: 10;
        }
        #ui { position: absolute; bottom: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px black; pointer-events: none; }
    </style>
</head>
<body>

    <div id="map-icon">MAP</div>
    <div id="ui">
        <b>WASD</b> to Move/Drive | <b>Q</b> to Punch | <b>Space</b> to Exit Car
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. SETUP
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. WORLD
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x2ecc71 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // THE ROAD
        const road = new THREE.Mesh(new THREE.PlaneGeometry(20, 500), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        road.rotation.x = -Math.PI / 2;
        road.position.y = 0.01;
        scene.add(road);

        // THE PARKING LOT (3 Slots)
        const lot = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), new THREE.MeshStandardMaterial({ color: 0x444444 }));
        lot.rotation.x = -Math.PI / 2;
        lot.position.set(25, 0.02, 0);
        scene.add(lot);

        // THE SKYSCRAPER
        const building = new THREE.Mesh(new THREE.BoxGeometry(15, 60, 15), new THREE.MeshStandardMaterial({ color: 0x7f8c8d }));
        building.position.set(0, 30, -30);
        scene.add(building);

        // 3. CARS
        const cars = [];
        const carColors = [0xff0000, 0x00ff00, 0xffff00];
        for(let i = 0; i < 3; i++) {
            const carGroup = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({ color: carColors[i] }));
            body.position.y = 0.5;
            const roof = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.8, 2), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            roof.position.y = 1.3;
            carGroup.add(body, roof);
            carGroup.position.set(20 + (i * 5), 0, 0);
            scene.add(carGroup);
            cars.push({ mesh: carGroup, occupied: false });
        }

        // 4. PLAYER
        const player = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0x3498db }));
        player.position.set(15, 1, 10);
        scene.add(player);

        // 5. LIGHTING
        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(10, 50, 10);
        scene.add(light, new THREE.AmbientLight(0x404040));

        // 6. LOGIC
        const keys = {};
        let currentCar = null;
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function update() {
            const speed = 0.2;
            const rotSpeed = 0.05;

            if (currentCar) {
                // Driving Logic
                if (keys['w']) currentCar.mesh.translateZ(-speed * 2);
                if (keys['s']) currentCar.mesh.translateZ(speed * 2);
                if (keys['a']) currentCar.mesh.rotation.y += rotSpeed;
                if (keys['d']) currentCar.mesh.rotation.y -= rotSpeed;
                
                // Follow car with player (hidden)
                player.position.copy(currentCar.mesh.position);
                
                if (keys[' ']) { // Exit car
                    currentCar.occupied = false;
                    currentCar = null;
                    player.position.x += 3;
                    player.visible = true;
                }
            } else {
                // Walking Logic
                if (keys['w']) player.position.z -= speed;
                if (keys['s']) player.position.z += speed;
                if (keys['a']) player.position.x -= speed;
                if (keys['d']) player.position.x += speed;

                // Check for car entry
                cars.forEach(car => {
                    if (player.position.distanceTo(car.mesh.position) < 2) {
                        currentCar = car;
                        car.occupied = true;
                        player.visible = false;
                    }
                });
            }

            // Q Punch
            if (keys['q']) player.scale.z = 1.8; else player.scale.z = 1;

            // Camera System
            const camOffset = currentCar ? new THREE.Vector3(0, 10, 20) : new THREE.Vector3(0, 5, 10);
            const targetPos = currentCar ? currentCar.mesh.position : player.position;
            camera.position.lerp(new THREE.Vector3(targetPos.x + camOffset.x, targetPos.y + camOffset.y, targetPos.z + camOffset.z), 0.1);
            camera.lookAt(targetPos);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
