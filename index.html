<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Underground 3D: East Slums</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { 
            position: absolute; top: 20px; left: 20px; color: #0f0; 
            background: rgba(0,0,0,0.85); padding: 15px; border-left: 4px solid #00aaff;
            pointer-events: none; z-index: 5; width: 220px;
        }
        .controls-overlay {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            display: flex; gap: 10px;
        }
        button {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 10px 15px; cursor: pointer; font-family: monospace;
            transition: 0.2s;
        }
        button:hover { background: #444; border-color: #00ffff; }
        #map-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; z-index: 8;
            justify-content: center; align-items: center; color: #00ffff;
            font-size: 24px; pointer-events: none;
        }
        .hp-bar { width: 100%; height: 8px; background: #300; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #f00; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-weight: bold;">SYNDICATE: v0.5</div>
        <div id="rep-display" style="color: #00aaff;">REP: 0</div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="zone-text" style="color: #ffff00; font-size: 12px; margin-top: 5px;">ZONE: DOWNTOWN</div>
    </div>

    <div class="controls-overlay">
        <button onclick="togglePause()" id="pauseBtn">PAUSE</button>
        <button onclick="toggleMap()" id="mapBtn">VIEW MAP</button>
    </div>

    <div id="map-overlay">SATELLITE VIEW ACTIVE</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Core Variables ---
        let paused = false, mapMode = false;
        let rep = 0, hp = 100;
        const enemies = [], buildings = [], streetLights = [];
        const keys = {};

        // --- Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050508);
        scene.fog = new THREE.Fog(0x050508, 20, 80);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Lighting ---
        const amb = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(amb);
        const hemi = new THREE.HemisphereLight(0x00aaff, 0xffaa00, 0.3);
        scene.add(hemi);

        // --- Environment Generation ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Helper: Create Districts
        function addDistrict(centerX, centerZ, count, type) {
            for(let i=0; i<count; i++) {
                const h = type === 'slum' ? 3 + Math.random()*4 : 15 + Math.random()*25;
                const w = type === 'slum' ? 4 : 8;
                const col = type === 'slum' ? 0x332211 : 0x0a0a0a;
                const b = new THREE.Mesh(new THREE.BoxGeometry(w, h, w), new THREE.MeshStandardMaterial({ color: col }));
                b.position.set(centerX + (Math.random()*40-20), h/2, centerZ + (Math.random()*40-20));
                scene.add(b);
                buildings.push(b);
                
                // Lights
                if(i % 3 === 0) {
                    const lCol = type === 'slum' ? 0xff6600 : 0x00ffff;
                    const lp = new THREE.PointLight(lCol, 15, 15);
                    lp.position.set(b.position.x, 5, b.position.z + (w/2 + 1));
                    scene.add(lp);
                    streetLights.push({ light: lp, original: 15 });
                }
            }
        }

        addDistrict(0, 0, 15, 'downtown'); // Center
        addDistrict(-60, 0, 25, 'slum');   // East Slums (Left of Downtown)

        // --- Player ---
        const player = new THREE.Group();
        const pBody = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 1), new THREE.MeshStandardMaterial({ color: 0x00aaff }));
        pBody.position.y = 1;
        player.add(pBody);
        scene.add(player);
        player.position.set(0, 0, 20);

        function spawnEnemy(x, z) {
            const e = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 1), new THREE.MeshStandardMaterial({ color: 0xff3333 }));
            e.position.set(x, 1, z);
            e.userData = { hp: 50 };
            scene.add(e);
            enemies.push(e);
        }
        spawnEnemy(-40, 5); spawnEnemy(-50, -5);

        // --- Input & Logic ---
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

        // Global UI Functions
        window.togglePause = () => {
            paused = !paused;
            document.getElementById('pauseBtn').innerText = paused ? "RESUME" : "PAUSE";
        };
        window.toggleMap = () => {
            mapMode = !mapMode;
            document.getElementById('map-overlay').style.display = mapMode ? 'flex' : 'none';
        };

        function update() {
            if (paused) return;

            // Camera Modes
            if (mapMode) {
                camera.position.lerp(new THREE.Vector3(player.position.x, 60, player.position.z + 0.1), 0.1);
            } else {
                camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 15, player.position.z + 20), 0.05);
            }
            camera.lookAt(player.position);

            // Movement
            const speed = 0.25;
            if (keys['w']) player.position.z -= speed;
            if (keys['s']) player.position.z += speed;
            if (keys['a']) player.position.x -= speed;
            if (keys['d']) player.position.x += speed;

            // Zone Detection
            const zoneText = document.getElementById('zone-text');
            if (player.position.x < -30) zoneText.innerText = "ZONE: EAST SLUMS";
            else zoneText.innerText = "ZONE: DOWNTOWN";

            // Flickering
            streetLights.forEach(s => {
                if(Math.random() > 0.98) s.light.intensity = Math.random() > 0.5 ? 0 : s.original;
            });

            // Combat
            if (keys[' ']) {
                pBody.scale.set(1.4, 0.8, 1.4);
                enemies.forEach((en, i) => {
                    if (player.position.distanceTo(en.position) < 3.5) {
                        en.userData.hp -= 2;
                        if (en.userData.hp <= 0) {
                            scene.remove(en);
                            enemies.splice(i, 1);
                            rep += 50;
                            document.getElementById('rep-display').innerText = `REP: ${rep}`;
                        }
                    }
                });
            } else pBody.scale.set(1, 1, 1);

            // AI
            enemies.forEach(en => {
                const d = en.position.distanceTo(player.position);
                if (d < 15) {
                    en.position.addScaledVector(new THREE.Vector3().subVectors(player.position, en.position).normalize(), 0.06);
                    if (d < 1.8) hp -= 0.2;
                }
            });

            document.getElementById('hp-fill').style.width = hp + "%";
            if (hp <= 0) location.reload();
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
