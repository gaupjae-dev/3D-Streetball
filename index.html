<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Underground 3D: Wheels & Warfare</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { 
            position: absolute; top: 20px; left: 20px; color: #0f0; 
            background: rgba(0,0,0,0.9); padding: 20px; border-left: 5px solid #00aaff;
            pointer-events: none; z-index: 10; width: 280px;
        }
        #mission-hud {
            position: absolute; bottom: 20px; right: 20px; color: #fff;
            background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #ffff00;
            width: 250px; text-align: right;
        }
        .hp-bar { width: 100%; height: 10px; background: #300; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: 0.2s; }
        .btn-group { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 20; }
        button { background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-size: 20px; font-weight: bold;">SYNDICATE</div>
        <div id="rep-display" style="color: #00aaff;">REP: 0</div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="status-text" style="color: #0ff; font-size: 12px; margin-top: 5px;">ON FOOT</div>
    </div>

    <div id="mission-hud">
        <div style="color: #ffff00; font-size: 14px;">OBJECTIVE</div>
        <div id="mission-text">Find a car in the Garage</div>
    </div>

    <div class="btn-group">
        <button id="pauseBtn">PAUSE</button>
        <button id="mapBtn">MAP</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Core Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x05050a);
        scene.fog = new THREE.Fog(0x05050a, 10, 100);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(amb);

        // --- Game State ---
        let hp = 100, rep = 0, paused = false, mapMode = false;
        let inVehicle = false;
        const keys = {};
        const buildings = [], enemies = [];

        // --- Map Creation ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Garage POI
        const garage = new THREE.Group();
        const gWall = new THREE.Mesh(new THREE.BoxGeometry(15, 6, 15), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        gWall.position.y = 3;
        garage.add(gWall);
        const gDoor = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), new THREE.MeshBasicMaterial({ color: 0x555555 }));
        gDoor.position.set(0, 2, 7.6);
        garage.add(gDoor);
        garage.position.set(20, 0, -20);
        scene.add(garage);
        buildings.push(gWall);

        // Downtown
        for(let i=0; i<10; i++) {
            const h = 20 + Math.random()*20;
            const b = new THREE.Mesh(new THREE.BoxGeometry(8, h, 8), new THREE.MeshStandardMaterial({ color: 0x0a0a0a }));
            b.position.set(Math.random()*100-50, h/2, Math.random()*100-50);
            if (b.position.distanceTo(garage.position) < 20) b.position.x += 30; 
            scene.add(b);
            buildings.push(b);
        }

        // --- The Vehicle ---
        const vehicle = new THREE.Group();
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({ color: 0xffcc00 }));
        carBody.position.y = 0.6;
        vehicle.add(carBody);
        const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.8, 2), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        cabin.position.set(0, 1.3, -0.5);
        vehicle.add(cabin);
        vehicle.position.set(20, 0, -12);
        scene.add(vehicle);
        let vehicleVel = 0, vehicleRot = 0;

        // --- The Player ---
        const player = new THREE.Group();
        const pMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0x00aaff }));
        pMesh.position.y = 1;
        player.add(pMesh);
        scene.add(player);
        player.position.set(0, 0, 10);

        // --- Input ---
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        document.getElementById('pauseBtn').onclick = () => paused = !paused;
        document.getElementById('mapBtn').onclick = () => mapMode = !mapMode;

        function update() {
            if (paused) return;

            if (!inVehicle) {
                // Character Movement
                let speed = 0.2;
                if (keys['w']) player.position.z -= speed;
                if (keys['s']) player.position.z += speed;
                if (keys['a']) player.position.x -= speed;
                if (keys['d']) player.position.x += speed;

                // Enter Vehicle Check
                if (player.position.distanceTo(vehicle.position) < 3) {
                    document.getElementById('mission-text').innerText = "Press 'E' to Drive";
                    if (keys['e']) {
                        inVehicle = true;
                        player.visible = false;
                        document.getElementById('status-text').innerText = "DRIVING";
                    }
                }
            } else {
                // Vehicle Physics
                if (keys['w']) vehicleVel += 0.01;
                if (keys['s']) vehicleVel -= 0.01;
                vehicleVel *= 0.98; // Friction

                if (Math.abs(vehicleVel) > 0.01) {
                    if (keys['a']) vehicleRot += 0.03;
                    if (keys['d']) vehicleRot -= 0.03;
                }

                vehicle.rotation.y = vehicleRot;
                vehicle.translateZ(-vehicleVel);

                // Exit Vehicle
                if (keys['f']) {
                    inVehicle = false;
                    player.visible = true;
                    player.position.copy(vehicle.position).x += 3;
                    document.getElementById('status-text').innerText = "ON FOOT";
                }
            }

            // Camera Follow
            const target = inVehicle ? vehicle : player;
            const camHeight = inVehicle ? 10 : 15;
            const camDist = inVehicle ? 20 : 20;

            if (mapMode) {
                camera.position.lerp(new THREE.Vector3(target.position.x, 80, target.position.z + 0.1), 0.1);
            } else {
                camera.position.lerp(new THREE.Vector3(target.position.x, target.position.y + camHeight, target.position.z + camDist), 0.05);
            }
            camera.lookAt(target.position);

            document.getElementById('hp-fill').style.width = hp + "%";
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
